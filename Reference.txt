【ファイル配置について】
/(root)
│  Changelog.txt                変更ログ
│  image.html                   画像ダウンロード用ページ
│  index.html                   トップページ
│  License.txt                  ライセンス
│  Readme.txt                   Readme
│  Reference.txt                この文章
│  
├─image/
│       *.jpg                   各マップの画像データ
│  
└─include/
    │   bb_compass.css          Web表示用のCSS
    │   bb_object.js            描画処理などを記述してある本体
    │   bb_object.min.js        bb_object.jsをYUI Compressorで縮小したもの
    │   bb_webfunc.js           Webのボタン動作などを記述したJavascript
    │   bb_webfunc.min.js       bb_webfunc.jsをYUI Compressorで縮小したもの
    │  
    ├─jcanvas/
    │       jCanvaScript.1.5.18.min.js
    │       jCanvaScript.1.5.18.js
    │      
    ├─jquery/
    │       jquery-1.7.1.min.js
    │       MIT-LICENSE.txt
    │      
    ├─scp/
    │       jquery.simple-color-picker.cs
    │       jquery.simple-color-picker.js
    │       LICENSE
    │      
    └─uuid/
             License.txt
             uuid.js


  このツールのディレクトリ構造はこんな感じです。
  bb_object.min.jsがツールのコア部分で、描画などの機能が作りこんであります。
  フォーム制御などインターフェース側のプログラムはbb_webfunc.min.jsが担います。
  index.htmlとbb_compass.cssはごく普通のHTMLとCSSファイルですね。

  bbobject.min.jsとbb_webfunc.min.jsは
  それぞれの元ファイルをWeb表示用に最小化(minimize)したものです。
  Webで公開する時には最小化版しか使わないのですが、
  改造する場合は人が読めないと困るので、元ファイルも同梱しています。
  (つまり、そのまま使うだけであれば.min.jsだけをアップロードすればOKです)

  また、下の方にあるjcanvas/jquery/uuid/scpの各ディレクトリは外部ライブラリです。
  基本的には配布されているものをそのまま利用しているのですが、
  jCanvaScriptはgithubから取得した物を自前でminimizeして利用しているため、
  一応元ファイルとminimizeしたファイルの双方を同梱しています。


【この文書で説明する範囲について】
  ファイル階層でも書いた通り、BBコンパスもどきは主に3階層でできています。
    Web関連の見栄えを決めるHTMLとCSS
    Webのボタンなどの動きを決めるbb_webfunc.min.js
    画像処理などを定義するbb_object.min.js

  本文書はコンパスもどきのコアであるbb_webfunc.jsについての説明がメインです。
  というより、ほとんどそれしか書いてありません。
  HTMLやcss、フォームの扱いについては特別なことはしていないので、
  世間に出回っている解説書などを参考にして下さい。


【bb_object.min.jsの利用例】
  //まず最初にBBオブジェクトを作る(引数はcanvasタグのID)
  //document.onloadなどで実行することをオススメします
  var bbobj=new BB("canvasID");

  //これ以後の機能はフォームのボタンなどを通じて実行させる想定です

  //背景を設定する
  //地図画像が160px=100mの場合、二つ目の引数は160/100=1.6を指定
  bbobj.setbg("/path/to/map.jpg",1.6);

  //オブジェクトを置く(半径50mのセンサーオブジェクトを配置する例)
  var sensor1=bbobj.set_scout("センサー",50,'#FF0000');  //画像オブジェクトが返ってくる
  var id=sensor1.id;

  //センサーの色を変えてみる
  sensor1.color('#00FF00');             //オブジェクト直指定
  bbobj.object(id).color('#0000FF');    //idを経由して呼び出すこともできる

  //センサーを移動させてみる
  sensor1.move(10,20);                  //右に10pixel、下に20pixel移動

  //背景に差分画像を重ねてみる
  bbobj.setbgdiff("/path/to/map_diff.jpg");

  //センサーを消す
  sensor1.del();


------------------------------------------------------------------------
【BBオブジェクトについて】
  BBオブジェクトはcanvasごとにインスタンスを生成して利用します。
  このオブジェクトを通じて、背景画像や差分画像を設定したり、
  マップ内に画像オブジェクトを生成することができます。

○BBオブジェクトの生成
  var bbobj=new BB("canvasID");
  引数：id        キャンバスタグのid


○BBオブジェクトのプロパティ
・id
  呼び出し時に指定したcanvasIDを指定します。
  書き込みはしないでください。オナシャス。


・scale
  地図の1メートルあたりのピクセル数を管理しています。
  背景を表示するときに一緒に指定したものを保管しているだけです。


・zoomScale
  拡大表示・縮小表示に利用する倍率を管理しています。


・imgscale
  地図画像を圧縮、伸長させている場合にその倍率を保持しています。
  これも背景を表示するときに一緒に指定したものを保管しているだけです。


○BBオブジェクトのメソッド
・setbg(string fipepath, num scale[, num imgscale])
  引数：filepath 地図画像のパス
        scale    1メートルあたりのピクセル数を指定
        imgscale 画像サイズを縮小、拡大したい場合に指定
  返値：なし

  背景画像を変更します。
  画像が変わるたびにピクセル/メートルの比率を指定してください。
  背景画像が大きすぎたり、小さすぎたりする場合は、
  imgscaleを指定することで画像を指定比率で縮小・拡大します。
  なお、imgscaleを指定した場合、scaleも同じ比率で補正されます。


・setbgdiff(string filepath)
  引数：filepath 差分画像のパス
  返値：なし

  背景画像の差分を設定します。
  この命令を複数回実行した場合、差分ファイルは差し替えされ、
  「指定した分だけ重ねる」という動作にはなりません。
  また、空文字列をパスとして渡すと、現在重ねている差分画像を消します。


・zoom(num scale)
  引数：scale    現在の状況からの倍率
  返値：obj      BBオブジェクト

  指定された倍率にあわせて拡大・縮小処理を行います。
  canvas自体も画像のサイズにあわせて拡大されます。

  倍率についてはjCanvaScriptなどの仕様に合わせているため、
  現在の倍率を基準とした相対指定しかできません。


・object(string id)
  引数：id       各オブジェクトのid
  返値：obj      画像オブジェクト

  描画済みオブジェクトの中から
  指定idを持つオブジェクトを返します


・save()
  引数：なし
  返値：txt      画像データ(dataスキーマ)

  現在の画像データをdataスキーマで返します。
  下のような形で使えば、画像データをもったimageオブジェクトが出来上がるので、
  それをDOMに挿入するなどして表示してください。

  var image=new Image;    // 新しいimgタグを準備
  image.src=bbobj.save()  // srcとしてsaveメソッドの出力を渡す
  

・pixel_to_meter(num pixel)
  引数：pixel    ピクセル指定の距離
  返値：meter    メートル指定の距離

  名の通り、ピクセル数を地図上のメートルに変換します
  変換の倍率はset_bgで背景を設定したときの値が利用されます。


・meter_to_pixel(num meter)
  引数：meter    メートル指定の距離
  返値：pixel    ピクセル指定の距離

  名の通り、地図上のメートルを画像のピクセル数に変換します
  変換の倍率はset_bgで背景を設定したときの値が利用されます。


・add_circle (string text, num radius[, string color])
  引数：text     オブジェクトの名前
        radius   円の初期半径(m単位)
        color    表示色  省略時は青色
  返値：obj      画像オブジェクト(円)

  円オブジェクトをcanvasに追加します
  返されるオブジェクトが持つメソッドについては、
  下にある画像オブジェクトのリファレンスを見てください。
  画像の基準点は円の中心が利用されます。


・add_line (string text, num length[, string color])
  引数：text     オブジェクトの名前
        length   直線の初期長さ(m単位)
        color    表示色  省略時は緑色
  返値：obj      画像オブジェクト(直線)

  直線オブジェクトをcanvasに追加します
  返されるオブジェクトが持つメソッドについては、
  下にある画像オブジェクトのリファレンスを見てください。
  画像の基準点は線を構成する二点の中心が利用されます。

・add_point (string text, num radius, [, string color [, num align]])
  引数：text     オブジェクトの名前
        radius   点の半径(pixel単位)
        color    表示色  省略時は黄色
        align    0なら文字を点の左に、1なら右に表示させる。省略時は右
  返値：obj      画像オブジェクト(直線)

  点オブジェクトをcanvasに追加します
  返されるオブジェクトが持つメソッドについては、
  下にある画像オブジェクトのリファレンスを見てください。
  画像の基準点は点を表現する円の中心が利用されます。

・add_scout (string text, num radius, num length, num duration [, string color])
  引数：text     オブジェクトの名前
        radius   偵察半径(m指定)
        length   偵察機が飛行する距離(m指定)
        duration 偵察機が「進む」時間(秒単位)
        color    表示色  省略時は赤色
  返値：obj      画像オブジェクト(偵察機)

  偵察機オブジェクトをcanvasに追加します
  返されるオブジェクトが持つメソッドについては、
  下にある画像オブジェクトのリファレンスを見てください。
  画像の基準点は偵察半径の中心が利用されます。


・add_sensor (string text, num radius [, string color])
  引数：text     オブジェクトの名前
        radius   偵察半径(m指定)
        color    表示色  省略時は赤色
  返値：obj      画像オブジェクト(センサー)

  センサーオブジェクトをcanvasに追加します
  返されるオブジェクトが持つメソッドについては、
  下にある画像オブジェクトのリファレンスを見てください。
  この画像の基準点は偵察半径の中心が利用されます。


・add_radar (string text, num radius, num angle [, string color])
  引数：text     オブジェクトの名前
        radius   偵察半径(m指定)
        angle    索敵角度(角度で指定)
        color    表示色  省略時は赤色
  返値：obj      画像オブジェクト(レーダー)

  レーダーオブジェクトをcanvasに追加します
  返されるオブジェクトが持つメソッドについては、
  下にある画像オブジェクトのリファレンスを見てください。
  この画像の基準点は索敵範囲を示す扇形の中心が利用されます。


・add_howitzer (string text, num radius1, num radius2, num radius3 [, string color])
  引数：text     オブジェクトの名前
        radius1  砲撃の射程(m指定)
        radius2  攻撃範囲(m指定)
        radius3  着弾誤差(m指定)
        color    表示色  省略時は黄色
  返値：obj      画像オブジェクト(榴弾)
 
  榴弾オブジェクトをcanvasに追加します
  返されるオブジェクトが持つメソッドについては、
  下にある画像オブジェクトのリファレンスを見てください。
  この画像の基準点は射程円の中心が利用されます。


・add_bunker (string text[, string color])
  引数：text     オブジェクトの名前
        color    表示色  省略時は紫色
  返値：obj      画像オブジェクト(バンカー)
 
  バンカーオブジェクトをcanvasに追加します
  返されるオブジェクトが持つメソッドについては、
  下にある画像オブジェクトのリファレンスを見てください。
  この画像の基準点は射程円の中心が利用されます。


・add_waft (string text, file[, string color])
  引数：text     オブジェクトの名前
        file     表示に利用するアイコンの場所
        color    表示色  省略時は紫色
  返値：obj      画像オブジェクト(バンカー)
 
  ワフトローダーオブジェクトをcanvasに追加します
  返されるオブジェクトが持つメソッドについては、
  下にある画像オブジェクトのリファレンスを見てください。
  この画像の基準点は射程円の中心が利用されます。

  なお、直径40m相当の色つき円の中に指定の画像を配置するのですが、
  その際、画像は高さか幅が円の直径と一致するように拡縮されます。
  画像ファイルは四角形で、画像の背景部分は円をはみ出すことになるので、
  指定する画像は必ず背景色を透明にしてください。


・add_freehand ([string color])
  引数：color    表示色  省略時は白色
  返値：obj      画像オブジェクト(フリーハンド)
 
  フリーハンドオブジェクトをcanvasに追加します
  このオブジェクトの振る舞いは画像オブジェクトとほぼ同じですが、
  内部的には結構いろいろな違いがあります。
  具体的な扱いは下にあるフリーハンドオブジェクトのリファレンスを見てください。


------------------------------------------------------------------------
【画像オブジェクトについて】
  画像オブジェクトはマップ内に配置される各画像を管理するもので、
  BBオブジェクトを通じて生成されます。

  このオブジェクトに対して命令を発行することで
  画像を移動させたり、重ねあい順序を変更したりできます。

  内部的には画像オブジェクトというスーパークラスがあり、
  円、直線、偵察機などそれぞれの画像はサブクラスとして実装されていますが、
  今のところ各オブジェクト固有のメソッドなどはありません。


○画像オブジェクトの持つプロパティ
・id
  画像オブジェクトの持つIDです。
  BBオブジェクトのobjectメソッドに引数として渡せば
  画像オブジェクトを得ることができます。
  Web側のフォームなどではこのIDで管理するのが楽だと思います。


・type
  オブジェクトの種別を示します。
  テキストで circle,line,radar,sensor,scout,howitzer のどれかが入ります
  このプロパティは管理用の情報であり、書き換えてもオブジェクトの型は変わりません。


・_color / _text / _lengthなど
  オブジェクト生成時に指定したパラメータです。
  これらの値はすべてプロパティとして保持されていて、
  頭にアンダースコアをつければ呼び出すことができます。

  変数名からもわかるとおり、外部からのアクセスはあまり想定していません。
  もし外部からこれらの値を変更した場合、
  redrawメソッドを使って画像オブジェクトを再描画してください。


○画像オブジェクトが持つ外部向けメソッド
・redraw()
  引数：なし
  返値：obj      画像オブジェクト

  オブジェクトを再描画します。


・position()
  引数：なし
  返値：hash     座標　連想配列で{x:x座標, y:y座標}

  画像基準点の現在位置(canvas内での座標)を連想配列の形で返します。
  「obj.position().x」という形で座標を呼び出してください。


・move(dx,dy)
  引数：dx       x方向の移動距離(pixel単位)
        dy       y方向の移動距離(pixel単位)
  返値：obj      画像オブジェクト

  x方向にdx、y方向にdy、画像をずらします。
  引数はピクセル単位なので注意してください。


・moveTo(x,y)
  引数：x        x方向の座標(pixel単位)
        y        y方向の座標(pixel単位)
  返値：obj      画像オブジェクト

  画像の基準点がcanvas内の指定座標にくるように画像を動かします。
  引数はピクセル単位なので注意してください。


・text()
  引数：なし
  返値：text     名前文字列

  オブジェクトに指定した名称を返します


・text(string text)
  引数：text     名前文字列
  返値：obj      画像オブジェクト

  オブジェクトの名称を変更します


・color()
  引数：なし
  返値：color    色指定

  オブジェクトの表示色を取得します


・color(string color)
  引数：color    色指定
  返値：obj      画像オブジェクト

  オブジェクトの表示色を設定します


・up()
  引数：なし
  返値：obj      画像オブジェクト

  画像の重ねあい順位を1段階上げます


・down()
  引数：なし
  返値：obj      画像オブジェクト

  画像の重ねあい順位を1段階下げます


・mouseup(function fn)
  引数：fn       コールバック関数
  返値：obj      画像オブジェクト

  オブジェクト内でマウスボタンを離したときに実行する関数を指定できます
  なお、コールバック関数の返り値がtrueだった場合、
  重ねあい順序が下のオブジェクトのmouseupイベントが発生します。
  下のオブジェクトのイベントを発生させたくない場合はfalseを返してください。


・mousedown(function fn)
  引数：fn       コールバック関数
  返値：obj      画像オブジェクト

  オブジェクト内でマウスボタンを押したときに実行する関数を指定できます
  なお、コールバック関数の返り値がtrueだった場合、
  重ねあい順序が下のオブジェクトのmousedownイベントが発生します。
  下のオブジェクトのイベントを発生させたくない場合はfalseを返してください。


・click(function fn)
  引数：fn       コールバック関数
  返値：obj      画像オブジェクト

  オブジェクト内でマウスボタンをクリックしたときに
  実行する関数を指定できます
  なお、コールバック関数の返り値がtrueだった場合、
  重ねあい順序が下のオブジェクトのclickイベントが発生します。
  下のオブジェクトのイベントを発生させたくない場合はfalseを返してください。


・dblclick(function fn)
  引数：fn       コールバック関数
  返値：obj      画像オブジェクト

  オブジェクト内でマウスボタンをダブルクリックしたときに
  実行する関数を指定できます
  なお、コールバック関数の返り値がtrueだった場合、
  重ねあい順序が下のオブジェクトのdblclickイベントが発生します。
  下のオブジェクトのイベントを発生させたくない場合はfalseを返してください。


・del()
  引数：なし
  返値：なし

  オブジェクトを削除します


------------------------------------------------------------------------
【フリーハンドオブジェクトについて】
  フリーハンドオブジェクトは手書き画像を扱うオブジェクトで、
  BBオブジェクトを通じて生成されます。

  ただ、色々な点で扱いが特殊なので画像オブジェクトの拡張ではなく、
  個別のオブジェクトとして定義されています。


○フリーハンドオブジェクトが持つプロパティ
・id
  フリーハンドオブジェクトの持つIDです。
  BBオブジェクトのobjectメソッドに引数として渡せば
  画像オブジェクトを得ることができます。
  Web側のフォームなどではこのIDで管理するのが楽だと思います。


・type
  オブジェクトの種別を示します。テキストで freehand が入ります。
  こちらも書き換えによってオブジェクトの実態が変わったりはしません。


○フリーハンドオブジェクトが持つ外部向けメソッド
・redraw()
  引数：なし
  返値：obj      画像オブジェクト

  オブジェクトを再描画します。


・color()
  引数：なし
  返値：color    色指定

  オブジェクトに現在指定されている色を取得します


・move(dx,dy)
  引数：dx       x方向の移動距離(pixel単位)
        dy       y方向の移動距離(pixel単位)
  返値：obj      画像オブジェクト

  x方向にdx、y方向にdy、画像をずらします。
  引数はピクセル単位なので注意してください。


・moveTo(x,y)
  引数：x        x方向の座標(pixel単位)
        y        y方向の座標(pixel単位)
  返値：obj      画像オブジェクト

  画像の基準点がcanvas内の指定座標にくるように画像を動かします。
  フリーハンドオブジェクトの基準点は
  引数はピクセル単位なので注意してください。


・color(string color)
  引数：color    色指定
  返値：obj      画像オブジェクト

  オブジェクトの次の描画で利用される色を設定します
  他のオブジェクトと異なり、すでに書かれた線には影響しません。


・start()
  引数：なし
  返値：obj      画像オブジェクト

  フリーハンド描画を開始します。
  描画中、他のオブジェクトのイベントは抑制されます。


・undo()
  引数：なし
  返値：obj      画像オブジェクト

  フリーハンド描画で最後に記入した線を消します。
  undoは何段階でも実行できますが、redoはありません（お粗末……）


・end()
  引数：なし
  返値：obj      画像オブジェクト

  フリーハンド描画を終了します。


・up()
  引数：なし
  返値：obj      画像オブジェクト

  画像の重ねあい順位を1段階上げます


・down()
  引数：なし
  返値：obj      画像オブジェクト

  画像の重ねあい順位を1段階下げます


・del()
  引数：なし
  返値：なし

  オブジェクトを削除します