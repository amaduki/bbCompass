var CanvasName="BBCompass";var DivName="CanvasArea";var scrollBarWidth=0;var scrollBarHeight=0;var freehandOnWrite=undefined;var bbobj="";var turretSpec={R:[200,180],G:[250,180],M:[250,180],L:[200,180]};var turretCircle=8;$(document).ready(function(){$("#lst_scout").change(function(){$("#name_scout").val($("#lst_scout option:selected").text())});$("#lst_sensor").change(function(){$("#name_sensor").val($("#lst_sensor option:selected").text())});$("#lst_radar").change(function(){$("#name_radar").val($("#lst_radar option:selected").text())});$("#lst_sonde").change(function(){$("#name_sonde").val($("#lst_sonde option:selected").text())});$("#lst_ndsensor").change(function(){$("#name_ndsensor").val($("#lst_ndsensor option:selected").text())});$("#lst_howitzer").change(function(){$("#name_howitzer").val($("#lst_howitzer option:selected").text())});$("#lst_misc").change(function(){$("#name_misc").val($("#lst_misc option:selected").text())});$("#lst_icon").change(function(){$("#name_icon").val($("#lst_icon option:selected").text())});var a=function(){$(this).css("background-color",$(this).val()).css("color",get_fgColor($(this).val()))};$("input.colorpick").simpleColorPicker({onChangeColor:a});$("input.colorpick").each(function(){$(this).bind("change",a)});$("input.colorpick").change();var b=$("#map").children().get();$("#stage").change(function(d){var c=$("#stage option:selected").val();$("#map").children().remove();$("#map").append(b);$("#map").children("[data-stage!='"+c+"']").remove()});$("#stage").change();$("#map").change(function(){$("#map").removeClass("union event");if($("#map option:selected").attr("class")!==undefined){$("#map").addClass($("#map option:selected").attr("class"))}});$("div#objselector div.option").click(function(){if($(this).hasClass("selected")){return false}else{$("div#objselector div.option.selected").removeClass("selected");$(this).addClass("selected")}var c=$(this).attr("data-target");$("div.setobj:visible").fadeOut("fast",function(){$("div.setobj#"+c).fadeIn("fast")})});$("div.ContextMenu").bind("contextmenu",function(c){c.preventDefault()});$("div.ContextMenu li.hasChild").bind("click",function(c){if(c.target==c.currentTarget){c.stopPropagation()}});$("div#CanvasArea").bind("contextmenu",function(c){c.preventDefault();var d={top:c.pageY,left:c.pageX};if(c.clientY+$("div.ContextMenu").height()>$(window).height()-3){d.top=$(window).height()-$("div.ContextMenu").height()+$(window).scrollTop()-3}if(c.clientX+$("div.ContextMenu").width()>$(window).width()-3){d.left=$(window).width()-$("div.ContextMenu").width()+$(window).scrollLeft()-3}$("div.ContextMenu").show().offset(d);$(document).one("click",function(){$("div.ContextMenu,div.ContextMenu div.ContextChild").hide()})});$("div.ContextMenu li.hasChild").hover(function(c){var d={top:$(this).offset().top,left:$(this).offset().left+$(this).width()*0.99};if($(this).offset().top-$(window).scrollTop()+$(this).children(".ContextChild").height()>$(window).height()){d.top=$(window).scrollTop()+$(window).height()-$(this).children(".ContextChild").height()-3}if($(this).offset().left-$(window).scrollLeft()+$(this).width()*0.99+$(this).children(".ContextChild").width()>$(window).width()){d.left=$(this).offset().left-$(this).children(".ContextChild").width()*0.99}$(this).children(".ContextChild").show().offset(d)},function(c){$(this).children(".ContextChild").hide()});$("#objselector").tinyscrollbar({invertscroll:true});$("#lst_scale").change(function(){zoom_cnv($(this).val())});$.ajax({url:"./Changelog.txt",dataType:"text",cache:false,success:function(c,d){$("#changelog").val(c)},error:function(){$("#changelog").val("更新履歴の取得に失敗しました")}})});function initialize(){var b=document.getElementById(CanvasName);if(!b||!b.getContext){alert("ブラウザがCanvas非対応なので、このブラウザでは動作しません");return false}bbobj=new BB(CanvasName);var a=document.getElementById(DivName);scrollBarWidth=a.offsetWidth-a.scrollWidth;scrollBarHeight=a.offsetHeight-a.scrollHeight+6;$("#"+DivName).width($("#"+CanvasName).outerWidth()+scrollBarWidth).height($("#"+CanvasName).outerHeight()+scrollBarHeight);$("#lst_layer").change(function(){bbobj.setbgdiff($("#lst_layer").val())});$("#"+DivName).scroll(function(){bbobj.chgScroll()})}function chg_map(){$("div#Loading").show();$("#lst_object").children().remove();var file=$("#map option:selected").val();var stage=$("#map option:selected").attr("data-stage");var layer=eval($("#map option:selected").attr("data-layer"));var scale=eval($("#stage").children("[value='"+stage+"']").attr("data-scale"));var salt="?"+new Date().getTime();bbobj.setbg("./map/"+stage+"/"+file+".jpg"+salt,scale[0],scale[1],function(){$("#"+DivName).width($("#"+CanvasName).outerWidth()+scrollBarWidth).height($("#"+CanvasName).outerHeight()+scrollBarHeight);$("#lst_scale").val(1);$("ul#contextZoom").children("li").removeClass("checked");$("li#contextZoom_1").addClass("checked");$("div#Loading").hide();$.ajax({url:"./data/"+file+".txt",dataType:"jsonp",crossDomain:true,cache:false,jsonp:false,jsonpCallback:"stageData",success:function(data,status){var turretData=data.turret;for(i=0;i<turretData.length;i++){bbobj.put_turret(turretData[i][0],turretData[i][1],turretData[i][2],turretSpec[turretData[i][3]][0],turretSpec[turretData[i][3]][1],turretCircle,undefined,turretData[i][4])}},error:function(){}})});$("#lst_layer").children().remove();$("#lst_layer").append($('<option value=""></option>').text("通常"));for(var i=0;i<layer.length;i++){$("#lst_layer").append($('<option value="./map/'+stage+"/"+file+"_"+(i+1)+".jpg"+salt+'"></option>').text(layer[i]))}$("#lst_layer").val("")}function set_scout(){if(!$("#lst_scout").val()){return}if(($("#name_scout").val()).length==0){name="("+$("#lst_scout option:selected").text()+")"}else{name=$("#name_scout").val()}if(!$("#col_scout").val()){return}var param=eval($("#lst_scout").val());var obj=bbobj.add_scout($("#name_scout").val(),param[0],param[1],param[2],$("#col_scout").val());add_object(obj.id,name);obj.move($("#"+DivName).scrollLeft(),$("#"+DivName).scrollTop());obj.mousedown(function(){$("#lst_object").val(obj.id);return false})}function set_sensor(){if(!$("#lst_sensor").val()){return}if(($("#name_sensor").val()).length==0){name="("+$("#lst_sensor option:selected").text()+")"}else{name=$("#name_sensor").val()}if(!$("#col_sensor").val()){return}var a=bbobj.add_sensor($("#name_sensor").val(),$("#lst_sensor").val(),$("#col_sensor").val());add_object(a.id,name);a.move($("#"+DivName).scrollLeft(),$("#"+DivName).scrollTop());a.mousedown(function(){$("#lst_object").val(a.id);return false})}function set_radar(){if(!$("#lst_radar").val()){return}if(($("#name_radar").val()).length==0){name="("+$("#lst_radar option:selected").text()+")"}else{name=$("#name_radar").val()}if(!$("#col_radar").val()){return}var param=eval($("#lst_radar").val());var obj=bbobj.add_radar($("#name_radar").val(),param[0],param[1],$("#col_radar").val());add_object(obj.id,name);obj.move($("#"+DivName).scrollLeft(),$("#"+DivName).scrollTop());obj.mousedown(function(){$("#lst_object").val(obj.id);return false})}function set_sonde(){if(!$("#lst_sonde").val()){return}if(($("#name_sonde").val()).length==0){name="("+$("#lst_sonde option:selected").text()+")"}else{name=$("#name_sonde").val()}if(!$("#col_sonde").val()){return}var param=eval($("#lst_sonde").val());var obj=bbobj.add_sonde($("#name_sonde").val(),param[0],param[1],$("#col_sonde").val());add_object(obj.id,name);obj.move($("#"+DivName).scrollLeft(),$("#"+DivName).scrollTop());obj.mousedown(function(){$("#lst_object").val(obj.id);return false})}function set_ndsensor(){if(!$("#lst_ndsensor").val()){return}if(($("#name_ndsensor").val()).length==0){name="("+$("#lst_desensor option:selected").text()+")"}else{name=$("#name_ndsensor").val()}if(!$("#col_ndsensor").val()){return}var a=bbobj.add_ndsensor($("#name_ndsensor").val(),$("#lst_ndsensor").val(),$("#col_ndsensor").val());add_object(a.id,name);a.move($("#"+DivName).scrollLeft(),$("#"+DivName).scrollTop());a.mousedown(function(){$("#lst_object").val(a.id);return false})}function set_howitzer(){if(!$("#lst_howitzer").val()){return}if(($("#name_howitzer").val()).length==0){name="("+$("#lst_howitzer option:selected").text()+")"}else{name=$("#name_howitzer").val()}if(!$("#col_howitzer").val()){return}var param=eval($("#lst_howitzer").val());var obj=bbobj.add_howitzer($("#name_howitzer").val(),param[0],param[1],param[2],$("#col_howitzer").val());add_object(obj.id,name);obj.move($("#"+DivName).scrollLeft(),$("#"+DivName).scrollTop());obj.mousedown(function(){$("#lst_object").val(obj.id);return false})}function set_misc(){if(!$("#lst_misc").val()){return}if(($("#name_misc").val()).length==0){name="("+$("#lst_misc option:selected").text()+")"}else{name=$("#name_misc").val()}if(!$("#col_misc").val()){return}var a;switch($("#lst_misc").val()){case"bunker":a=bbobj.add_bunker($("#name_misc").val(),$("#col_misc").val());break;case"sentry":a=bbobj.add_sentry($("#name_misc").val(),$("#col_misc").val());break;case"aerosent":a=bbobj.add_aerosentry($("#name_misc").val(),$("#col_misc").val());break;case"bomber":a=bbobj.add_bomber($("#name_misc").val(),$("#col_misc").val());break}if(a){add_object(a.id,name);a.move($("#"+DivName).scrollLeft(),$("#"+DivName).scrollTop());a.mousedown(function(){$("#lst_object").val(a.id);return false})}}function set_icon(){if(!$("#lst_icon").val()){return}if(($("#name_icon").val()).length==0){name="("+$("#lst_icon option:selected").text()+"アイコン)"}else{name=$("#name_icon").val()}if(!$("#col_icon").val()){return}var a=bbobj.add_icon($("#name_icon").val(),$("#lst_icon").val(),$("#col_icon").val());add_object(a.id,name);a.move($("#"+DivName).scrollLeft(),$("#"+DivName).scrollTop());a.mousedown(function(){$("#lst_object").val(a.id);return false})}function set_waft(a){if(!a){return}if(($("#name_waft").val()).length==0){name="(ワフトローダー)"}else{name=$("#name_waft").val()}if(!$("#col_waft").val()){return}var b=bbobj.add_waft($("#name_waft").val(),a,$("#col_waft").val());add_object(b.id,name);b.move($("#"+DivName).scrollLeft(),$("#"+DivName).scrollTop());b.mousedown(function(){$("#lst_object").val(b.id);return false})}function set_circle(){if(!$("#rad_circle").val()){return}if(($("#name_circle").val()).length==0){name="(円)"}else{name=$("#name_circle").val()}if(!$("#col_circle").val()){return}var a=bbobj.add_circle($("#name_circle").val(),$("#rad_circle").val(),$("#col_circle").val());add_object(a.id,name);a.move($("#"+DivName).scrollLeft(),$("#"+DivName).scrollTop());a.mousedown(function(){$("#lst_object").val(a.id);return false})}function set_line(){if(!$("#len_line").val()){return}if(($("#name_line").val()).length==0){name="(直線)"}else{name=$("#name_line").val()}if(!$("#col_line").val()){return}var a=bbobj.add_line($("#name_line").val(),$("#len_line").val(),$("#col_line").val());add_object(a.id,name);a.move($("#"+DivName).scrollLeft(),$("#"+DivName).scrollTop());a.mousedown(function(){$("#lst_object").val(a.id);return false})}function set_point(){var a=bbobj.add_point($("#name_point").val(),$("#size_point").val(),$("#col_point").val(),$("#align_point").val());if(($("#name_point").val()).length==0){name="(点)"}else{name=$("#name_point").val()}add_object(a.id,name);a.move($("#"+DivName).scrollLeft(),$("#"+DivName).scrollTop());a.mousedown(function(){$("#lst_object").val(a.id);return false})}function set_freehand(){var b=bbobj.add_freehand($("#col_freehand").val());if(($("#name_freehand").val()).length==0){name="(フリーハンド)"}else{name=$("#name_freehand").val()}add_object(b.id,name);$("button").attr("disabled",true);b.start();freehandOnWrite=b;var a=function(){b.color($(this).val())};$("#stop_freehand").attr("disabled",false).click(function(){freehandOnWrite=undefined;b.end();$("#col_freehand").unbind("blur",a);$("button:not(.disable)").attr("disabled",false);$("#stop_freehand").attr("disabled",true).unbind("click")});$("#col_freehand").bind("blur",a)}function zoom_cnv(c){var d,b,a=document.getElementById(CanvasName);d=c;$("#lst_scale").val(d);liid=d.toString().replace(".","_");$("ul#contextZoom").children("li").removeClass("checked");$("li#contextZoom_"+liid).addClass("checked");var b=d/bbobj.zoomScale;if(bbobj.zoomScale!=d){bbobj.zoom(b);$("#"+DivName).scrollLeft($("#"+DivName).scrollLeft()*b).scrollTop($("#"+DivName).scrollTop()*b)}}function start_move(){$("button").attr("disabled",true);$("li#contextSelectMode").removeClass("checked");$("li#contextMoveMode").addClass("checked");$("div#csr_select").removeClass("selected");$("div#csr_move").addClass("selected");$("canvas#"+CanvasName).css("cursor","move");if(freehandOnWrite!==undefined){freehandOnWrite.end()}bbobj.jcanvas.pause(CanvasName);var d,e,a,c,b;e=function(h){var g=h.pageX-c,f=h.pageY-b;$("#"+DivName).scrollLeft($("#"+DivName).scrollLeft()-g);$("#"+DivName).scrollTop($("#"+DivName).scrollTop()-f);c=h.pageX;b=h.pageY;return false};a=function(f){$("#"+DivName).unbind("mousemove",e);$("#"+DivName).unbind("mouseup",a);return false};d=function(f){c=f.pageX;b=f.pageY;$("#"+DivName).bind("mousemove",e);$("#"+DivName).bind("mouseup",a);return false};$("#"+DivName).mousedown(d)}function stop_move(){$("button:not(.disable)").attr("disabled",false);$("li#contextSelectMode").addClass("checked");$("li#contextMoveMode").removeClass("checked");$("div#csr_select").addClass("selected");$("div#csr_move").removeClass("selected");$("canvas#"+CanvasName).css("cursor","auto");bbobj.jcanvas.start(CanvasName,true);$("#"+DivName).unbind("mousedown");if(freehandOnWrite!==undefined){$("button").attr("disabled",true);freehandOnWrite.start();$("#stop_freehand").attr("disabled",false)}}function add_object(b,a){if($("#lst_object").children("option").get().length){$('<option value="'+b+'"></option>').text(a).insertBefore($("#lst_object :first-child"))}else{$("#lst_object").append($('<option value="'+b+'"></option>').text(a))}$("#lst_object").val(b)}function up_object(){$("#lst_object option:not(:selected)").each(function(){while($(this).next().is(":selected")){$(this).insertAfter($(this).next());bbobj.object($(this).val()).down()}})}function down_object(){$($("#lst_object option:not(:selected)").get().reverse()).each(function(){while($(this).prev().is(":selected")){$(this).insertBefore($(this).prev());bbobj.object($(this).val()).up()}})}function hide_menu(){$("div.ribbonmenu").slideUp(function(){$("#menusw_off").hide();$("#menusw_on").show()})}function show_menu(){$("div.ribbonmenu").slideDown(function(){$("#menusw_on").hide();$("#menusw_off").show()})}function del_object(){$("#lst_object option:selected").each(function(){bbobj.object($(this).val()).del();$(this).remove()})}function saveImg(){$("#WorkArea").append($("<img id=DownloadImg src='"+bbobj.save()+"'>"));window.open("./image.html","test")}function get_fgColor(a){if(a.search(/#[0-9a-fA-F]{6}/)==-1){return("#000000")}$r=parseInt(a.substr(1,2),16);$g=parseInt(a.substr(3,2),16);$b=parseInt(a.substr(5,2),16);$bright=(($r*299)+($g*587)+($b*114))/1000;if($bright<127.5){return("#FFFFFF")}return("#000000")};