jc.addFunction("rotateTo",function(f,a,c,e,g,d,b){this.optns.rotateMatrix=[[1,0,0],[0,1,0]];return this.rotate.apply(this,arguments)});jc.addFunction("getAngle",function(){var a=this.optns.rotateMatrix;return(a[1][0]>0)?Math.acos(a[0][0]):(-1)*Math.acos(a[0][0])});jc.addObject("imgdiff",{image:new Image,x:0,y:0,width:false,height:false,sx:0,sy:0,swidth:false,sheight:false},function(b){if(this._width===false){this._width=this._image.width;this._height=this._image.height}if(this._swidth===false){this._swidth=this._image.width;this._sheight=this._image.height}var a=b.globalCompositeOperation;b.globalCompositeOperation="lighter";b.drawImage(this._image,this._sx,this._sy,this._swidth,this._sheight,this._x,this._y,this._width,this._height);b.globalCompositeOperation=a;this.getRect=function(c){return{x:this._x,y:this._y,width:this._width,height:this._height}}});jc.addObject("scout",{x:0,y:0,radius:0,length:0,color:"rgb(255, 0, 0)",fill:false},function(c){var b=this._x,e=this._y,a=this._radius,d=this._length;c.moveTo(b+d*0.5,e+a);c.arc(b,e,a,Math.PI*0.5,Math.PI*1.5,false);c.lineTo(b+d*0.5,e-a);c.arc(b+d,e,a,Math.PI*1.5,Math.PI*0.5,false);c.lineTo(b+d*0.5,e+a);c.closePath();this.getRect=function(){return{x:(this._x),y:(this._y),width:(this._length+this._radius*2),height:(this._radius*2)}}});jc.addObject("scout_mask",{x:0,y:0,radius:0,length:0,color:"rgba(0, 0, 0, 0)",fill:true},function(c){var b=this._x,e=this._y,a=this._radius,d=this._length;c.moveTo(b+d*0.5,e+a);c.arc(b,e,a,Math.PI*0.5,Math.PI*1.5,true);c.lineTo(b+d*0.5,e-a);c.arc(b+d,e,a,Math.PI*1.5,Math.PI*0.5,false);c.lineTo(b+d*0.5,e+a);c.closePath();this.getRect=function(){return{x:(this._x),y:(this._y),width:(this._length+this._radius),height:(this._radius*2)}}});jc.addObject("sector",{x:0,y:0,radius:0,angle:0,color:"rgb(255, 0, 0)",fill:false},function(c){var b=this._x,f=this._y,a=this._radius,e=this._angle;var d=e*Math.PI/180;c.moveTo(b,f);c.arc(b,f,a,d/2,d/(-2),true);c.closePath();this.getRect=function(){return{x:(this._x),y:(this._y),width:(this._radius),height:(2*Math.sin(this._angle*Math.PI/360))}}});jc.addObject("crosshair",{x:0,y:0,color:"rgb(255, 255, 255)"},function(a){var c=20;var b=6;a.moveTo(this._x-c,this._y);a.lineTo(this._x-c+b,this._y);a.closePath();a.moveTo(this._x-c+b*2,this._y);a.lineTo(this._x+c-b*2,this._y);a.closePath();a.moveTo(this._x+c-b,this._y);a.lineTo(this._x+c,this._y);a.closePath();a.moveTo(this._x,this._y-c);a.lineTo(this._x,this._y-c+b);a.closePath();a.moveTo(this._x,this._y-c+b*2);a.lineTo(this._x,this._y+c-b*2);a.closePath();a.moveTo(this._x,this._y+c-b);a.lineTo(this._x,this._y+c);a.closePath();a.lineWidth=3;this.getRect=function(){return{x:(this._x-c),y:(this._y-c),width:c*2,height:c*2}}});var BB=function(d){this.member={};this.id=d;this.jcanvas=jc.start(d,true);this.scale=1;this.zoomScale=1;this.imgscale=1;var b=this,c=this.jcanvas,a=document.getElementById(this.id);this.touchToMouse(a);this.BB_base=function(){this._text="base";this._color="#000000"};this.BB_base.prototype.draw=function(){};this.BB_base.prototype.redraw=function(){c.layer(this.id).objects().del();this.draw()};this.BB_base.prototype.applyZoom=function(h,g,f){var e=jc.layer(this.id)._transformdx,k=jc.layer(this.id)._transformdy;jc.layer(this.id).translate(e*h-e,k*h-k);this.redraw()};this.BB_base.prototype.toString=function(){return this.id};this.BB_base.prototype.position=function(){var e=c.layer(this.id)._transformdx;var f=c.layer(this.id)._transformdy;return{x:e,y:f}};this.BB_base.prototype.click=function(e){c.layer(this.id).click(e);return this};this.BB_base.prototype.mouseup=function(e){c.layer(this.id).mouseup(e);return this};this.BB_base.prototype.mousedown=function(e){c.layer(this.id).mousedown(e);return this};this.BB_base.prototype.dblclick=function(e){c.layer(this.id).dblclick(e);return this};this.BB_base.prototype.move=function(f,e){c.layer(this.id).translate(f,e);return this};this.BB_base.prototype.rotateTo=function(e){c.layer(this.id).rotateTo(e);return this};this.BB_base.prototype.moveTo=function(g,f){var e=c.layer(this.id)._transformdx;var h=c.layer(this.id)._transformdy;c.layer(this.id).translate(g-e,f-h);return this};this.BB_base.prototype.color=function(e){if(e===undefined){return this._color}this._color=e;this.redraw();return this};this.BB_base.prototype.text=function(e){if(e===undefined){return this._text}this._text=e;this.redraw();return this};this.BB_base.prototype.regist=function(){b.member[this.id]=this};this.BB_base.prototype.up=function(){var f=c.layer(this.id).level();var e=b.nextlevel(f);if(e.id!==undefined){c.layer(e.id).level(f);c.layer(this.id).level(e.level);return true}else{return false}};this.BB_base.prototype.down=function(){var f=c.layer(this.id).level();var e=b.prevlevel(f);if(e.id!==undefined){c.layer(e.id).level(f);c.layer(this.id).level(e.level);return true}else{return false}};this.BB_base.prototype.del=function(){delete b.member[this.id];var e=c.layer(this.id).objs;c.layer(this.id).del()};this.BB_circle=function(g,e,h){if(h===undefined){h="rgb(0, 51, 255)"}this.id=UUID.genV1().toString();this.type="circle";this._text=g;this._radius=e;this._color=h;var f=b.meter_to_pixel(this._radius);this._ptpos={x:f,y:0};this.move(f,f);this.draw();this.regist()};this.BB_circle.prototype=new this.BB_base();this.BB_circle.prototype.draw=function(){var p=b.meter_to_pixel(this._radius),o=this._ptpos.x,n=this._ptpos.y,h=this;var f=c.circle(0,0,p,this._color,true).opacity(0.3).layer(this.id),m=c.circle(0,0,p,this._color,false).opacity(1).lineStyle({lineWidth:3}).layer(this.id),s=c.line({points:[[0,0],[o,n]],color:this._color}).lineStyle({lineWidth:3}).layer(this.id).opacity(1);c.circle(0,0,7,this._color,true).opacity(1).layer(this.id);var e=c.circle(0,0,5,"#FFFFFF",true).layer(this.id);c.text(this._text,0,-10).layer(this.id).color("#FFFFFF").font("15px sans-serif").align("center");var g=c.circle(o,n,7,this._color,true).layer(this.id).opacity(1),r=c.circle(o,n,5,"#FFFFFF",true).layer(this.id),l=c.text(Math.floor(this._radius)+"m",o/2,n/2).baseline("top").align("center").color("#FFFFFF").font("15px sans-serif").layer(this.id);c.layer(this.id).draggable();var k=l.getRect().height;var q=function(){var w=e.position(),v=r.position(),u=v.x-w.x,t=v.y-w.y,z=(w.x+v.x)/2,x=(w.y+v.y)/2,y=Math.sqrt(Math.pow(u,2)+Math.pow(t,2));g.translateTo(v.x,v.y);s.points([[0,0],[r._x+r._transformdx,r._y+r._transformdy]]);f.attr("radius",y);m.attr("radius",y);l.translateTo(z,x-k).string(Math.floor(b.pixel_to_meter(y))+"m");h._radius=b.pixel_to_meter(y);h._ptpos={x:r._x+r._transformdx,y:r._y+r._transformdy}};r.draggable(q);r.optns.drag.val=false;r.mouseover(function(){c.layer(h.id).optns.drag.val=false;r.optns.drag.val=true});r.mouseout(function(){c.layer(h.id).optns.drag.val=true;r.optns.drag.val=false});return this};this.BB_circle.prototype.applyZoom=function(g,f,e){this._ptpos.x=this._ptpos.x*g;this._ptpos.y=this._ptpos.y*g;b.BB_base.prototype.applyZoom.apply(this,arguments);return this};this.BB_line=function(f,h,g){if(g===undefined){g="rgb(51, 153, 0)"}this.id=UUID.genV1().toString();this.type="line";this._text=f;this._length=h;this._color=g;var e=b.meter_to_pixel(this._length);this._pt1pos={x:(-1)*e/2,y:0};this._pt2pos={x:e/2,y:0};this.draw();this.move(100+e/2,100);this.regist()};this.BB_line.prototype=new this.BB_base();this.BB_line.prototype.position=function(){var f=(this._pt1pos.x+this._pt2pos.x)/2,e=(this._pt1pos.y+this._pt2pos.y)/2;return{x:f,y:e}};this.BB_line.prototype.moveTo=function(g,f){var h=c.layer(this.id);var e=h._transformdx+(this._pt1pos.x+this._pt2pos.x)/2,k=h._transformdy+(this._pt1pos.y+this._pt2pos.y)/2;h.translate(g-e,f-k);return this};this.BB_line.prototype.draw=function(){var w=15,p=5,v=this._pt1pos.x,h=this._pt1pos.y,t=this._pt2pos.x,g=this._pt2pos.y,q=this;var s=(v+t)/2,r=(h+g)/2;var n=c.line({points:[[v,h],[t,g]],color:this._color}).opacity(1).lineStyle({lineWidth:3}).layer(this.id),x=c.circle(v,h,7,this._color,true).layer(this.id),m=c.circle(v,h,5,"#FFFFFF",true).layer(this.id),e=c.circle(t,g,7,this._color,true).layer(this.id),l=c.circle(t,g,5,"#FFFFFF",true).layer(this.id),o=c.text(this._text,s,r+w).align("center").color("#FFFFFF").font("15px sans-serif").layer(this.id),f=c.text(Math.floor(this._length)+"m",s,r-p).align("center").color("#FFFFFF").font("15px sans-serif").layer(this.id);c.layer(this.id).draggable();var u=f.getRect().height;var k=function(){var B=m.position(),A=l.position(),z=A.x-B.x,y=A.y-B.y,E=(B.x+A.x)/2,C=(B.y+A.y)/2,D=Math.sqrt(Math.pow(z,2)+Math.pow(y,2));x.translateTo(B.x,B.y);e.translateTo(A.x,A.y);n.points([[m._x+m._transformdx,m._y+m._transformdy],[l._x+l._transformdx,l._y+l._transformdy]]);o.translateTo(E,C+w-u);f.translateTo(E,C-p-u).string(Math.floor(b.pixel_to_meter(D))+"m");q._length=b.pixel_to_meter(D);q._pt1pos={x:m._x+m._transformdx,y:m._y+m._transformdy};q._pt2pos={x:l._x+l._transformdx,y:l._y+l._transformdy}};m.draggable(k);m.optns.drag.val=false;l.draggable(k);l.optns.drag.val=false;m.mouseover(function(){c.layer(q.id).optns.drag.val=false;m.optns.drag.val=true});m.mouseout(function(){c.layer(q.id).optns.drag.val=true;m.optns.drag.val=false});l.mouseover(function(){c.layer(q.id).optns.drag.val=false;l.optns.drag.val=true});l.mouseout(function(){c.layer(q.id).optns.drag.val=true;l.optns.drag.val=false});return this};this.BB_line.prototype.applyZoom=function(g,f,e){this._pt1pos.x=this._pt1pos.x*g;this._pt1pos.y=this._pt1pos.y*g;this._pt2pos.x=this._pt2pos.x*g;this._pt2pos.y=this._pt2pos.y*g;b.BB_base.prototype.applyZoom.apply(this,arguments);return this};this.BB_point=function(g,e,h,f){if(h===undefined){h="rgb(0, 0, 0)"}if(f===undefined){f=0}this.id=UUID.genV1().toString();this.type="point";this._text=g;this._size=parseInt(e);this._align=f;this._color=h;this.draw();this.move(100,100);this.regist()};this.BB_point.prototype=new this.BB_base();this.BB_point.prototype.draw=function(){c.circle(0,0,this._size,this._color,true).opacity(1).layer(this.id);if(this._align==1){var e=c.text(this._text,(-1)*(this._size+5),0).layer(this.id).color("#FFFFFF").font("15px sans-serif").align("right").baseline("middle")}else{var e=c.text(this._text,this._size+5,0).layer(this.id).color("#FFFFFF").font("15px sans-serif").align("left").baseline("middle")}c.layer(this.id).draggable();return this};this.BB_scout=function(g,e,l,k,h){if(h===undefined){h="rgb(255, 0, 0)"}this.id=UUID.genV1().toString();this.type="scout";this._text=g;this._radius=e;this._length=l;this._duration=k;this._color=h;this.draw();var f=b.meter_to_pixel(this._radius);this.move(f,f);this.regist()};this.BB_scout.prototype=new this.BB_base();this.BB_scout.prototype.draw=function(){var l=b.meter_to_pixel(this._radius),k=b.meter_to_pixel(this._length),m=this;var n=c.circle(0,0,l,this._color,false).layer(this.id).opacity(1),e=c.circle(0,0,l,this._color,true).opacity(0.3).layer(this.id),h=c.scout(0,0,l,k,this._color,true).opacity(0.2).layer(this.id),g=c.scout(0,0,l,k,this._color,false).opacity(1).layer(this.id),f=c.scout_mask(0,0,l,k).layer(this.id);c.circle(0,0,3,"#FFFFFF",true).layer(this.id);c.text(this._text,0,-10).align("center").color("#FFFFFF").font("15px sans-serif").layer(this.id);c.layer(this.id).draggable();f.mousedown(function(o){var r=jc.canvas(b.id),q=c.rect(0,0,r.width(),r.height(),"rgba(0, 0, 0, 0)").layer("tmp_"+m.id),s=c.layer(m.id),v=c.layer("tmp_"+m.id);v.level("top");var p=e.position();var u=Math.atan2((o.y-p.y),(o.x-p.x)),t=s.getAngle();q.mousemove(function(y){var x=Math.atan2((y.y-p.y),(y.x-p.x));var w=t+(x-u);s.rotateTo((w*180/Math.PI),0,0)});q.mouseup(function(w){c.layer("tmp_"+m.id).del()})});f.mouseover(function(){c.layer(m.id).optns.drag.val=false});f.mouseout(function(){c.layer(m.id).optns.drag.val=true});f.dblclick(function(){e.translate(k,0,m._duration*1000,undefined,{fn:function(){n.animate({x:e._transformdx,y:e._transformdy})}},function(){m.redraw()});return false});return this};this.BB_sensor=function(g,e,h){if(h===undefined){h="rgb(255, 0, 0)"}this.id=UUID.genV1().toString();this.type="sensor";this._text=g;this._radius=e;this._color=h;this.draw();var f=b.meter_to_pixel(this._radius);this.move(f,f);this.regist()};this.BB_sensor.prototype=new this.BB_base();this.BB_sensor.prototype.draw=function(){var e=b.meter_to_pixel(this._radius);c.circle(0,0,e,this._color,false).opacity(1).layer(this.id);c.circle(0,0,e,this._color,true).opacity(0.5).layer(this.id);c.circle(0,0,3,this._color,true).layer(this.id).color("#FFFFFF");c.text(this._text,0,-10).align("center").layer(this.id).color("#FFFFFF").font("15px sans-serif");c.layer(this.id).draggable();return this};this.BB_radar=function(g,f,e,k){if(k===undefined){k="rgb(255, 0, 0)"}this.id=UUID.genV1().toString();this.type="radar";this._text=g;this._radius=f;this._angle=e;this._color=k;this._image=new Image;this._image.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAIAAAC0tAIdAAAABnRSTlMA/wD/AP83WBt9AAAAZUlEQVR42qWRSwrAMAhEK4j3v64LMZQGk5hJsdRVxjw/g+TuVzlopoloJxYgBERTQabTYinZ6WgM6cgvNHQ8f930o1VVROCcKBj0bveNHuPOEuwNaeCyNzi8f1zHzJi5evlKfKMbjWF644wwKScAAAAASUVORK5CYII=";var h=this;this._image.onload=function(){h.draw();var l=b.meter_to_pixel(h._radius);h.move(l,l);h.regist()}};this.BB_radar.prototype=new this.BB_base();this.BB_radar.prototype.draw=function(){var k=b.meter_to_pixel(this._radius),l=this,e=this._image.width,n=this._image.height,g=Math.sqrt(Math.pow(this._image.width,2)+Math.pow(this._image.height,2))*0.5;c.sector(0,0,k,this._angle,this._color,false).opacity(1).layer(this.id);var h=c.sector(0,0,k,this._angle,this._color,true).opacity(0.5).layer(this.id);c.circle(0,0,g,this._color,true).opacity(0.9).layer(this.id);c.circle(0,0,g-2,"#ffffff",true).layer(this.id);c.image(this._image,e*(-0.5),n*(-0.5),e,n).layer(this.id).rotate(90);var m=c.text(this._text,60,0).align("center").layer(this.id).color("#FFFFFF").font("15px sans-serif");c.layer(this.id).draggable();var f=function(o){var q=h.position(),p=jc.canvas(b.id);k=b.meter_to_pixel(l._radius),radius=Math.sqrt(Math.pow((o.x-q.x),2)+Math.pow((o.y-q.y),2)),startrad=Math.atan2((o.y-q.y),(o.x-q.x)),baserad=c.layer(l.id).getAngle(),tmpmask=c.rect(0,0,p.width(),p.height(),"rgba(0, 0, 0, 0)").layer("tmp_"+l.id),layer=c.layer(l.id),tmpLayer=c.layer("tmp_"+l.id);tmpLayer.level("top");tmpmask.mousemove(function(u){var t=h.position(),s=Math.atan2((u.y-t.y),(u.x-t.x)),r=baserad+(s-startrad);layer.rotateTo((r*180/Math.PI),0,0)});tmpmask.mouseup(function(){tmpLayer.del()})};h.mousedown(f);h.mouseover(function(){c.layer(l.id).optns.drag.val=false});h.mouseout(function(){c.layer(l.id).optns.drag.val=true});m.mousedown(f);m.mouseover(function(){c.layer(l.id).optns.drag.val=false});m.mouseout(function(){c.layer(l.id).optns.drag.val=true});return this};this.BB_howitzer=function(h,g,e,l,k){if(k===undefined){k="#FFA500"}this.id=UUID.genV1().toString();this.type="howitzer";this._text=h;this._radius1=g;this._radius2=e;this._radius3=l;this._color=k;this._markerx=0;this._markery=0;this.draw();var f=b.meter_to_pixel(this._radius1);this.move(f,f);this.regist()};this.BB_howitzer.prototype=new this.BB_base();this.BB_howitzer.prototype.draw=function(){var n=b.meter_to_pixel(this._radius1),m=b.meter_to_pixel(this._radius2),l=b.meter_to_pixel(this._radius3)+m,g=this;c.circle(0,0,n,this._color,false).opacity(1).layer(this.id);var h=c.circle(0,0,n,this._color,true).opacity(0.2).layer(this.id);c.circle(0,0,3,"#FFFFFF",true).layer(this.id);var e=c.circle(this._markerx,this._markery,l,this._color,false).opacity(1).layer(this.id),k=c.circle(this._markerx,this._markery,m,this._color,false).opacity(1).layer(this.id),o=c.crosshair(this._markerx,this._markery).layer(this.id),f=c.circle(this._markerx,this._markery,m,this._color,true).opacity(0.3).layer(this.id);c.text(this._text,0,-40).align("center").color("#FFFFFF").font("15px sans-serif").layer(this.id);c.layer(this.id).draggable();f.draggable(function(w){var r=true,u=f.position(),p=h.position(),q=c.layer(g.id),A=w.x-p.x,z=w.y-p.y;if(Math.sqrt(Math.pow(A,2)+Math.pow(z,2))>n){r=false}else{r=true}if(r){k.translateTo(u.x,u.y);o.translateTo(u.x,u.y);e.translateTo(u.x,u.y)}else{var s=Math.atan2((w.y-p.y),(w.x-p.x));var v=p.x+n*Math.cos(s);var t=p.y+n*Math.sin(s);f.translateTo(v,t);f.translateTo(v,t);k.translateTo(v,t);o.translateTo(v,t);e.translateTo(v,t)}g._markerx=e._x+e._transformdx;g._markery=e._y+e._transformdy});f.optns.drag.val=false;f.mouseover(function(){c.layer(g.id).optns.drag.val=false;f.optns.drag.val=true});f.mouseout(function(){c.layer(g.id).optns.drag.val=true;f.optns.drag.val=false});f.dblclick(function(){var p=h.position();f.translateTo(p.x,p.y);k.translateTo(p.x,p.y);o.translateTo(p.x,p.y);e.translateTo(p.x,p.y);g._markerx=e._x+e._transformdx;g._markery=e._y+e._transformdy;return false});return this};this.BB_howitzer.prototype.applyZoom=function(g,f,e){this._markerx=this._markerx*g;this._markery=this._markery*g;b.BB_base.prototype.applyZoom.apply(this,arguments);return this};this.BB_bunker=function(f,g){if(g===undefined){g="rgb(255, 0, 165)"}this.id=UUID.genV1().toString();this.type="bunker";this._text=f;this._rad1=28;this._rad2=40;this._color=g;this.draw();var e=b.meter_to_pixel(this._rad2);this.move(e,e);this.regist()};this.BB_bunker.prototype=new this.BB_base();this.BB_bunker.prototype.draw=function(){var f=b.meter_to_pixel(this._rad1);var e=b.meter_to_pixel(this._rad2);c.circle(0,0,f,this._color,true).opacity(0.3).layer(this.id);c.circle(0,0,f,this._color,false).opacity(1).layer(this.id);c.circle(0,0,e,this._color,true).opacity(0.2).layer(this.id);c.circle(0,0,e,this._color,false).opacity(1).layer(this.id);c.circle(0,0,3,this._color,true).layer(this.id).color("#FFFFFF");c.text(this._text,0,-10).align("center").layer(this.id).color("#FFFFFF").font("15px sans-serif");c.layer(this.id).draggable();return this};this.BB_sentry=function(e,g){if(g===undefined){g="rgb(255, 0, 0)"}this.id=UUID.genV1().toString();this.type="sentry";this._text=e;this._radius=80;this._angle=120;this._color=g;this._image=new Image;this._image.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAIAAAC0tAIdAAAABnRSTlMA/wD/AP83WBt9AAAAYUlEQVR42pWRUQ7AIAhD13txN7gbB2PLWMxUROSrJq8NVJjZVR4MNAAXYUpHP2h7/nVHt7xk3PkFrAyq6oKIgk1cMLOIZHtv0biTM7ra4NaAOOM1ZPRc4ln2bFv+TvXKZG6yP1bjQ2hwBAAAAABJRU5ErkJggg==";var f=this;this._image.onload=function(){f.draw();var h=b.meter_to_pixel(f._radius);f.move(h,h);f.regist()}};this.BB_sentry.prototype=new this.BB_base();this.BB_sentry.prototype.draw=function(){var k=b.meter_to_pixel(this._radius),l=this,e=this._image.width,n=this._image.height,g=Math.sqrt(Math.pow(this._image.width,2)+Math.pow(this._image.height,2))*0.5;c.sector(0,0,k,this._angle,this._color,false).opacity(1).layer(this.id);var h=c.sector(0,0,k,this._angle,this._color,true).opacity(0.5).layer(this.id);c.circle(0,0,g,this._color,true).opacity(0.9).layer(this.id);c.circle(0,0,g-2,"#ffffff",true).layer(this.id);c.image(this._image,e*(-0.5),n*(-0.5),e,n).layer(this.id);var m=c.text(this._text,50,0).align("center").layer(this.id).color("#FFFFFF").font("15px sans-serif");c.layer(this.id).draggable();var f=function(o){var q=h.position(),p=jc.canvas(b.id);k=b.meter_to_pixel(l._radius),radius=Math.sqrt(Math.pow((o.x-q.x),2)+Math.pow((o.y-q.y),2)),startrad=Math.atan2((o.y-q.y),(o.x-q.x)),baserad=c.layer(l.id).getAngle(),tmpmask=c.rect(0,0,p.width(),p.height(),"rgba(0, 0, 0, 0)").layer("tmp_"+l.id),layer=c.layer(l.id),tmpLayer=c.layer("tmp_"+l.id);tmpLayer.level("top");tmpmask.mousemove(function(u){var t=h.position(),s=Math.atan2((u.y-t.y),(u.x-t.x)),r=baserad+(s-startrad);layer.rotateTo((r*180/Math.PI),0,0)});tmpmask.mouseup(function(){tmpLayer.del()})};h.mousedown(f);h.mouseover(function(){c.layer(l.id).optns.drag.val=false});h.mouseout(function(){c.layer(l.id).optns.drag.val=true});m.mousedown(f);m.mouseover(function(){c.layer(l.id).optns.drag.val=false});m.mouseout(function(){c.layer(l.id).optns.drag.val=true});return this};this.BB_bomber=function(f,g){if(g===undefined){g="rgb(255, 0, 165)"}this.id=UUID.genV1().toString();this.type="bomber";this._text=f;this._rad1=30;this._rad2=0;this._center=[50,65,80,95,110,125,140,155,170,185,200,215];this._color=g;this.draw();var e=b.meter_to_pixel(this._rad1);this.move(e,e);this.regist()};this.BB_bomber.prototype=new this.BB_base();this.BB_bomber.prototype.draw=function(){var m=b.meter_to_pixel(this._rad1),l=m+b.meter_to_pixel(this._rad2),n=b.meter_to_pixel(this._center[this._center.length-1]),f=[],e=[];for(var k=0;k<this._center.length;++k){e[k]=b.meter_to_pixel(this._center[k])}c.scout(0,0,m,n,this._color,true).opacity(0.2).layer(this.id);c.scout(0,0,m,n,this._color,false).opacity(1).layer(this.id);var o=c.circle(0,0,3,this._color,true).layer(this.id).color("#FFFFFF");for(var k=0;k<this._center.length;++k){c.circle(e[k],0,m,this._color,false).opacity(1).layer(this.id),c.circle(e[k],0,l,this._color,true).opacity(0.3).layer(this.id)}var g=(c.layer(this.id).getAngle())*(-180)/Math.PI;for(var k=0;k<this._center.length;++k){f.push(c.crosshair(e[k],0).layer(this.id).rotateTo(g,e[k],0))}c.text(this._text,0,-10).align("center").layer(this.id).color("#FFFFFF").font("15px sans-serif");c.layer(this.id).draggable();var p=c.scout_mask(0,0,m,n).layer(this.id),h=this;p.mousedown(function(q){var s=jc.canvas(b.id),r=c.rect(0,0,s.width(),s.height(),"rgba(0, 0, 0, 0)").layer("tmp_"+h.id),t=c.layer(h.id),x=c.layer("tmp_"+h.id);x.level("top");var u=o.position();var w=Math.atan2((q.y-u.y),(q.x-u.x)),v=t.getAngle();r.mousemove(function(B){var z=Math.atan2((B.y-u.y),(B.x-u.x));var y=v+(z-w);t.rotateTo((y*180/Math.PI),0,0);for(var A=0;A<f.length;++A){f[A].rotateTo((y*(-180)/Math.PI),e[A],0)}});r.mouseup(function(y){c.layer("tmp_"+h.id).del()})});p.mouseover(function(){c.layer(h.id).optns.drag.val=false});p.mouseout(function(){c.layer(h.id).optns.drag.val=true});return this};this.BB_icon=function(f,e,h){if(h===undefined){h="rgb(0, 255, 255)"}this.id=UUID.genV1().toString();this.type="icon";this._text=f;this._color=h;this._image=new Image;this._image.src=e;var g=this;this._image.onload=function(){var k=Math.sqrt(Math.pow(g._image.width,2)+Math.pow(g._image.height,2));g.draw();g.move(k,k);g.regist()}};this.BB_icon.prototype=new this.BB_base();this.BB_icon.prototype.draw=function(){var e=this._image.width,g=this._image.height,f=Math.sqrt(Math.pow(this._image.width,2)+Math.pow(this._image.height,2))*0.5;c.circle(0,0,f,this._color,true).opacity(0.9).layer(this.id);c.circle(0,0,f-2,"#FFFFFF",true).layer(this.id);c.image(this._image,e*(-0.5),g*(-0.5),e,g).layer(this.id);c.text(this._text,e*0.5+5,0).layer(this.id).color("#FFFFFF").font("15px sans-serif").align("left").baseline("middle");c.layer(this.id).draggable();return this};this.BB_waft=function(g,e,k){if(k===undefined){k="rgb(0, 255, 255)"}this.id=UUID.genV1().toString();this.type="waft";this._text=g;this._rad=20;this._color=k;this._image=new Image;this._image.src=e;var h=this,f=b.meter_to_pixel(this._rad);this._image.onload=function(){h.draw();h.move(f,f);h.regist()}};this.BB_waft.prototype=new this.BB_base();this.BB_waft.prototype.draw=function(){var k=b.meter_to_pixel(this._rad),e=this._image.width,n=this._image.height,h=k*2/((e>=n)?e:n);e=e*h;n=n*h;var l=c.circle(0,0,k+(10*b.zoomScale),this._color,true).opacity(0.3).layer(this.id);c.circle(0,0,k,this._color,true).opacity(1).layer(this.id);c.image(this._image,e*(-0.5),n*(-0.5),e,n).layer(this.id);c.layer(this.id).draggable();var m=this,g=jc.layer(this.id),f=jc.canvas(b.id);l.mousedown(function(o){var p=l.position();var q=c.rect(0,0,f.width(),f.height(),"rgba(0, 0, 0, 0)").layer("tmp_"+m.id);jc.layer("tmp_"+m.id).level("top");var s=Math.atan2((o.y-p.y),(o.x-p.x)),r=g.getAngle();q.mousemove(function(v){var u=Math.atan2((v.y-p.y),(v.x-p.x));var t=r+(u-s);g.rotateTo((t*180/Math.PI),0,0)});q.mouseup(function(t){c.layer("tmp_"+m.id).del()})});l.mouseover(function(){g.optns.drag.val=false});l.mouseout(function(){g.optns.drag.val=true});return this};this.BB_freehand=function(e){if(e===undefined){e="rgb(255, 255, 255)"}this.id=UUID.genV1().toString();this.type="freehand";this._color=e;this._step=0;this._stepcol=new Array;this._hooker=undefined;c.rect(0,0,1,1,"rgba(0, 0, 0, 0)").layer(this.id);this.regist()};this.BB_freehand.prototype.color=function(e){if(e===undefined){return this._color}this._color=e;return this};this.BB_freehand.prototype.toString=this.BB_base.prototype.toString;this.BB_freehand.prototype.regist=this.BB_base.prototype.regist;this.BB_freehand.prototype.up=this.BB_base.prototype.up;this.BB_freehand.prototype.down=this.BB_base.prototype.down;this.BB_freehand.prototype.del=this.BB_base.prototype.del;this.BB_freehand.prototype.move=this.BB_base.prototype.move;this.BB_freehand.prototype.moveTo=this.BB_base.prototype.moveTo;this.BB_freehand.prototype.redraw=function(){for(i=1;i<=this._step;i++){var e=jc("#"+i,{canvas:b.id,layer:this.id}).points();jc("#"+i,{canvas:b.id,layer:this.id}).del();c.line(e,this._stepcol[i]).layer(this.id).id(i).lineStyle({lineWidth:3})}};this.BB_freehand.prototype.applyZoom=function(k,g,f){var e=jc.layer(this.id)._transformdx,l=jc.layer(this.id)._transformdy;jc.layer(this.id).translate(e*k-e-g*k,l*k-l-f*k);for(i=1;i<=this._step;i++){var h=jc("#"+i,{canvas:b.id,layer:this.id}).points();for(j=0;j<h.length;j++){h[j]=[(h[j])[0]*k,(h[j])[1]*k]}jc("#"+i,{canvas:b.id,layer:this.id}).del();c.line(h,this._stepcol[i]).layer(this.id).id(i).lineStyle({lineWidth:3})}};this.BB_freehand.prototype.start=function(){var h=this,g=c.layer(this.id),f=jc.canvas(b.id);if(this._hooker!==undefined){return}this._hooker=UUID.genV1().toString();var e=c.rect(0,0,f.width(),f.height(),"rgba(0, 0, 0, 0)").layer(this._hooker).level("top");e.click(function(){return false});e.dblclick(function(){return false});e.mousemove(function(){return false});e.mousedown(function(l){h._step++;h._stepcol[h._step]=h._color;var k=c.line([[l.x,l.y],[l.x,l.y]],h._color).layer(h.id).id(h._step).lineStyle({lineWidth:3});e.mousemove(function(m){k.addPoint(m.x,m.y);return false});return false});e.mouseup(function(){e.mousemove(function(){});return false});return this};this.BB_freehand.prototype.undo=function(){if(this._step!=0){jc("#"+this._step,{canvas:b.id,layer:this.id}).del();this._step--}return this};this.BB_freehand.prototype.end=function(){(jc.layer(this._hooker)).del();this._hooker=undefined;return this}};BB.prototype.touchToMouse=function(a){var g=5;var h=0,f=false,k=false,b=0,e=0,d=0;var c=this;function n(o){var p;switch(o.type){case"touchstart":p=o.touches[0];h=p.identifier;break;case"touchmove":for(i=0;i<o.changedTouches.length;i++){if(o.changedTouches[i].identifier==h){p=o.changedTouches[i];break}}break;case"touchend":for(i=0;i<o.changedTouches.length;i++){if(o.changedTouches[i].identifier==h){p=o.changedTouches[i];break}}break}if(p===undefined){return false}return p}function m(o,q){var p=document.createEvent("MouseEvent");p.initMouseEvent(o,true,true,window,((o=="dblclick")?2:1),q.screenX,q.screenY,q.clientX,q.clientY,false,false,false,false,0,null);q.target.dispatchEvent(p)}function l(v){var t=jc.canvas(c.id).cnv.getBoundingClientRect();var p=v.clientX-t.left,u=v.clientY-t.top,o=false;for(var r in (c.member)){if((c.object(r)).type!="freehand"){o=jc.layer(r).isPointIn(p,u)}else{o=((c.object(r))._hooker!==undefined)}if(o){break}}if(!o){var q=jc(".turrets").elements;for(var s=0;s<q.length;s++){o=q[s].isPointIn(p,u);if(o){break}}}return o}a.addEventListener("touchstart",function(o){var p=n(o);k=l(p);if(!k){return}o.preventDefault();f=true;if(b&&(Math.abs(e-p.clientX)>g||Math.abs(d-p.clientY)>g)){clearTimeout(b);b=0}e=p.clientX;d=p.clientY;m("mousemove",p);jc.canvas(BB.id).frame();m("mousedown",p);return false},false);a.addEventListener("touchmove",function(t){if(!k){return}var u=n(t);t.preventDefault();var s=t.target.getBoundingClientRect();var r=s.left,p=s.top,q=t.target.offsetWidth||t.target.width,o=t.target.offsetHeight||t.target.height;if(u.clientX>r&&u.clientY>p&&u.clientX<r+q&&u.clientY<p+o){if(!f){m("mouseover",u)}m("mousemove",u);f=true}else{if(f){m("mouseout",u)}f=false}},false);a.addEventListener("touchend",function(o){if(!k){return}o.preventDefault();if(!f){return}var p=n(o);m("mouseup",p);if(Math.abs(e-p.clientX)<g&&Math.abs(d-p.clientY)<g){if(b){m("click",p);m("dblclick",p);clearTimeout(b);b=0}else{m("click",p);b=setTimeout(function(){b=0},500);e=p.clientX;d=p.clientY}}f=false},false)};BB.prototype.meter_to_pixel=function(a){return(a*(this.scale*this.zoomScale))};BB.prototype.pixel_to_meter=function(a){return(a/(this.scale*this.zoomScale))};BB.prototype.setbg=function(c,b,a,g){var e=new Image,d=this.jcanvas,f=this.id;if(a===undefined){a=1}e.src=c;e.onload=function(){var h=document.getElementById(f);h.width=e.width*a;h.height=e.height*a;jc.clear(f);d.image(e,0,0,e.width*a,e.height*a).level(-1).id("bg");if(g!==undefined){g()}jc.start(f,true)};this.scale=b*a;this.imgscale=a;this.zoomScale=1;this.member={}};BB.prototype.setbgdiff=function(b){var d=new Image;var c=this.jcanvas;var e=this.id;var a=this.imgscale;if(b){d.src=b;d.onload=function(){c("#bgdiff").del();c.imgdiff(d,0,0,d.width*a,d.height*a).level(0).id("bgdiff");jc.canvas(e).frame()}}else{c("#bgdiff").del();jc.canvas(e).frame()}};BB.prototype.object=function(a){return this.member[a]};BB.prototype.nextlevel=function(d){var a=undefined,b=undefined;for(var c in this.member){if((a===undefined)&&(this.jcanvas.layer(c).level()>d)){a=this.jcanvas.layer(c).level();b=c}else{if((this.jcanvas.layer(c).level()>d)&&(this.jcanvas.layer(c).level()<a)){a=this.jcanvas.layer(c).level();b=c}}}return{id:b,level:a}};BB.prototype.prevlevel=function(d){var a=undefined,b=undefined;for(var c in this.member){if((a===undefined)&&(this.jcanvas.layer(c).level()<d)){a=this.jcanvas.layer(c).level();b=c}else{if((this.jcanvas.layer(c).level()<d)&&(this.jcanvas.layer(c).level()>a)){a=this.jcanvas.layer(c).level();b=c}}}return{id:b,level:a}};BB.prototype.save=function(){return(jc.canvas(this.id).toDataURL("image/png"))};BB.prototype.put_turret=function(m,l,b,g,d,h,e,k){if(m===undefined){return undefined}if(l===undefined){return undefined}if(b===undefined){return undefined}if(g===undefined){return undefined}if(d===undefined){return undefined}if(h===undefined){h=8}if(e===undefined){e="rgb(255, 153, 0)"}if(k===undefined){k=false}var c=false,n=bbobj.meter_to_pixel(g),a=this.jcanvas.sector(m,l,n,d,e,true).rotateTo(b-90,m,l).opacity(0.3).visible(c).level(1),o=this.jcanvas.sector(m,l,n,d,this.color,false).level(1).rotateTo(b-90,m,l).opacity(1).visible(c),f=this.jcanvas.circle(m,l,h,"rgba(0,0,0,0)",true).rotateTo(b-90,m,l).level(3).name("turrets");if(k){this.jcanvas.line([[m,l],[m,l-20]],"rgba(255,255,255,1)").rotateTo(b,m,l).lineStyle({lineWidth:2});f.color("rgba(255,255,255,1)").level("top")}f.mouseover(function(){a.visible(true);o.visible(true)});f.mouseout(function(){a.visible(c);o.visible(c)});f.click(function(){c=!(c);a.visible(c);o.visible(c)})};BB.prototype.add_scout=function(c,a,d,e,b){return new this.BB_scout(c,a,d,e,b)};BB.prototype.add_sensor=function(c,a,b){return new this.BB_sensor(c,a,b)};BB.prototype.add_radar=function(c,a,d,b){return new this.BB_radar(c,a,d,b)};BB.prototype.add_howitzer=function(d,e,c,b,a){return new this.BB_howitzer(d,e,c,b,a)};BB.prototype.add_bunker=function(b,a){return new this.BB_bunker(b,a)};BB.prototype.add_sentry=function(b,a){return new this.BB_sentry(b,a)};BB.prototype.add_bomber=function(b,a){return new this.BB_bomber(b,a)};BB.prototype.add_circle=function(c,a,b){return new this.BB_circle(c,a,b)};BB.prototype.add_line=function(b,c,a){return new this.BB_line(b,c,a)};BB.prototype.add_point=function(b,c,a,d){return new this.BB_point(b,c,a,d)};BB.prototype.add_icon=function(b,c,a){return new this.BB_icon(b,c,a)};BB.prototype.add_waft=function(b,c,a){return new this.BB_waft(b,c,a)};BB.prototype.add_freehand=function(a){return new this.BB_freehand(a)};BB.prototype.zoom=function(d){if(d===undefined){return(this.zoomScale)}var c=jc.canvas(this.id).cnv,a=jc.canvas(this.id).layers[0];this.zoomScale=this.zoomScale*d;a.scale(d);for(var b in (this.member)){this.object(b).applyZoom(d)}c.width=jc("#bg").getRect().width;c.height=jc("#bg").getRect().height;this.chgScroll();jc.canvas(this.id).frame();return this};BB.prototype.chgScroll=function(){jc.canvas(this.id).recalculateOffset()};