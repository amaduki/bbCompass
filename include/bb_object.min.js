jc.addFunction("rotateTo",function(f,a,c,e,g,d,b){this.optns.rotateMatrix=[[1,0,0],[0,1,0]];return this.rotate.apply(this,arguments)});jc.addObject("imgdiff",{image:new Image,x:0,y:0,width:false,height:false,sx:0,sy:0,swidth:false,sheight:false},function(b){if(this._width===false){this._width=this._image.width;this._height=this._image.height}if(this._swidth===false){this._swidth=this._image.width;this._sheight=this._image.height}var a=b.globalCompositeOperation;b.globalCompositeOperation="lighter";b.drawImage(this._image,this._sx,this._sy,this._swidth,this._sheight,this._x,this._y,this._width,this._height);b.globalCompositeOperation=a;this.getRect=function(c){return{x:this._x,y:this._y,width:this._width,height:this._height}}});jc.addObject("scout",{x:0,y:0,radius:0,length:0,color:"rgb(255, 0, 0)",fill:true},function(c){var b=this._x,e=this._y,a=this._radius,d=this._length;c.moveTo(b+d*0.5,e+a);c.arc(b,e,a,Math.PI*0.5,Math.PI*1.5,false);c.lineTo(b+d*0.5,e-a);c.arc(b+d,e,a,Math.PI*1.5,Math.PI*0.5,false);c.lineTo(b+d*0.5,e+a);c.closePath();this.getRect=function(){return{x:(this._x),y:(this._y),width:(this._length+this._radius*2),height:(this._radius*2)}}});jc.addObject("scout_mask",{x:0,y:0,radius:0,length:0,color:"rgba(0, 0, 0, 0)",fill:true},function(c){var b=this._x,e=this._y,a=this._radius,d=this._length;c.moveTo(b+d*0.5,e+a);c.arc(b,e,a,Math.PI*0.5,Math.PI*1.5,true);c.lineTo(b+d*0.5,e-a);c.arc(b+d,e,a,Math.PI*1.5,Math.PI*0.5,false);c.lineTo(b+d*0.5,e+a);c.closePath();this.getRect=function(){return{x:(this._x),y:(this._y),width:(this._length+this._radius),height:(this._radius*2)}}});jc.addObject("radar",{x:0,y:0,radius:0,angle:0,color:"rgb(255, 0, 0)",fill:false},function(c){var b=this._x,f=this._y,a=this._radius,e=this._angle;var d=e*Math.PI/180;c.moveTo(b,f);c.arc(b,f,a,d/2,d/(-2),true);c.closePath();this.getRect=function(){return{x:(this._x),y:(this._y),width:(this._radius),height:(2*Math.sin(this._angle*Math.PI/360))}}});jc.addObject("crosshair",{x:0,y:0,color:"rgb(255, 255, 255)"},function(a){var c=20;var b=6;a.moveTo(this._x-c,this._y);a.lineTo(this._x-c+b,this._y);a.closePath();a.moveTo(this._x-c+b*2,this._y);a.lineTo(this._x+c-b*2,this._y);a.closePath();a.moveTo(this._x+c-b,this._y);a.lineTo(this._x+c,this._y);a.closePath();a.moveTo(this._x,this._y-c);a.lineTo(this._x,this._y-c+b);a.closePath();a.moveTo(this._x,this._y-c+b*2);a.lineTo(this._x,this._y+c-b*2);a.closePath();a.moveTo(this._x,this._y+c-b);a.lineTo(this._x,this._y+c);a.closePath();a.lineWidth=3;this.getRect=function(){return{x:(this._x-c),y:(this._y-c),width:c*2,height:c*2}}});var BB=function(d){this.member={};this.id=d;this.jcanvas=jc.start(d,true);this.scale=1;this.imgscale=1;var b=this,c=this.jcanvas,a=document.getElementById(this.id);this.touchToMouse(a);this.BB_base=function(){this._text="base";this._color="#000000"};this.BB_base.prototype.draw=function(){};this.BB_base.prototype.redraw=function(){c.layer(this.id).objects().del();this.draw()};this.BB_base.prototype.toString=function(){return this.id};this.BB_base.prototype.position=function(){var e=c.layer(this.id)._transformdx;var f=c.layer(this.id)._transformdy;return{x:e,y:f}};this.BB_base.prototype.click=function(e){c.layer(this.id).click(e);return this};this.BB_base.prototype.mouseup=function(e){c.layer(this.id).mouseup(e);return this};this.BB_base.prototype.mousedown=function(e){c.layer(this.id).mousedown(e);return this};this.BB_base.prototype.dblclick=function(e){c.layer(this.id).dblclick(e);return this};this.BB_base.prototype.move=function(f,e){c.layer(this.id).translate(f,e);return this};this.BB_base.prototype.moveTo=function(g,f){var e=c.layer(this.id)._transformdx;var h=c.layer(this.id)._transformdy;c.layer(this.id).translate(g-e,f-h);return this};this.BB_base.prototype.color=function(e){if(e===undefined){return this._color}this._color=e;this.redraw();return this};this.BB_base.prototype.text=function(e){if(e===undefined){return this._text}this._text=e;this.redraw();return this};this.BB_base.prototype.regist=function(){b.member[this.id]=this};this.BB_base.prototype.up=function(){var f=c.layer(this.id).level();var e=b.nextlevel(f);if(e.id!==undefined){c.layer(e.id).level(f);c.layer(this.id).level(e.level);return true}else{return false}};this.BB_base.prototype.down=function(){var f=c.layer(this.id).level();var e=b.prevlevel(f);if(e.id!==undefined){c.layer(e.id).level(f);c.layer(this.id).level(e.level);return true}else{return false}};this.BB_base.prototype.del=function(){delete b.member[this.id];c.layer(this.id).del()};this.BB_circle=function(g,e,h){if(h===undefined){h="rgb(0, 51, 255)"}this.id=UUID.genV1().toString();this.type="circle";this._text=g;this._radius=e;this._color=h;var f=b.meter_to_pixel(this._radius);this._ptpos={x:f,y:0};this.move(f,f);this.draw();this.regist()};this.BB_circle.prototype=new this.BB_base();this.BB_circle.prototype.draw=function(){var n=b.meter_to_pixel(this._radius),m=this._ptpos.x,l=this._ptpos.y,h=this;var f=c.circle(0,0,n,this._color,true).opacity(0.3).layer(this.id),k=c.circle(0,0,n,this._color,false).opacity(1).lineStyle({lineWidth:3}).layer(this.id),q=c.line({points:[[0,0],[m,l]],color:this._color}).lineStyle({lineWidth:3}).layer(this.id).opacity(1);c.circle(0,0,7,this._color,true).opacity(1).layer(this.id);var e=c.circle(0,0,5,"#FFFFFF",true).layer(this.id);c.text(this._text,0,-10).layer(this.id).color("#FFFFFF").font("15px sans-serif").align("center");var g=c.circle(m,l,7,this._color,true).layer(this.id).opacity(1),p=c.circle(m,l,5,"#FFFFFF",true).layer(this.id);radius=c.text(Math.floor(this._radius)+"m",m/2,l/2).baseline("top").align("center").color("#FFFFFF").font("15px sans-serif").layer(this.id);c.layer(this.id).draggable();var j=radius.getRect().height;var o=function(){var u=e.position(),t=p.position(),s=t.x-u.x,r=t.y-u.y,x=(u.x+t.x)/2,v=(u.y+t.y)/2,w=Math.sqrt(Math.pow(s,2)+Math.pow(r,2));g.translateTo(t.x,t.y);q.points([[0,0],[p._x+p._transformdx,p._y+p._transformdy]]);f.attr("radius",w);k.attr("radius",w);radius.translateTo(x,v-j).string(Math.floor(b.pixel_to_meter(w))+"m");h._radius=b.pixel_to_meter(w);h._ptpos={x:p._x+p._transformdx,y:p._y+p._transformdy}};p.draggable(o);p.optns.drag.val=false;p.mouseover(function(){c.layer(h.id).optns.drag.val=false;p.optns.drag.val=true});p.mouseout(function(){c.layer(h.id).optns.drag.val=true;p.optns.drag.val=false});return this};this.BB_line=function(f,h,g){if(g===undefined){g="rgb(51, 153, 0)"}this.id=UUID.genV1().toString();this.type="line";this._text=f;this._length=h;this._color=g;var e=b.meter_to_pixel(this._length);this._pt1pos={x:(-1)*e/2,y:0};this._pt2pos={x:e/2,y:0};this.draw();this.move(100+e/2,100);this.regist()};this.BB_line.prototype=new this.BB_base();this.BB_line.prototype.position=function(){var f=(this._pt1pos.x+this._pt2pos.x)/2,e=(this._pt1pos.y+this._pt2pos.y)/2;return{x:f,y:e}};this.BB_line.prototype.moveTo=function(g,f){var h=c.layer(this.id);var e=h._transformdx+(this._pt1pos.x+this._pt2pos.x)/2,j=h._transformdy+(this._pt1pos.y+this._pt2pos.y)/2;h.translate(g-e,f-j);return this};this.BB_line.prototype.draw=function(){var j=15,m=5,e=this._pt1pos.x,k=this._pt1pos.y;x2=this._pt2pos.x,y2=this._pt2pos.y;obj=this;var q=(e+x2)/2,p=(k+y2)/2;var r=c.line({points:[[e,k],[x2,y2]],color:this._color}).opacity(1).lineStyle({lineWidth:3}).layer(this.id),h=c.circle(e,k,7,this._color,true).layer(this.id),n=c.circle(e,k,5,"#FFFFFF",true).layer(this.id),f=c.circle(x2,y2,7,this._color,true).layer(this.id),l=c.circle(x2,y2,5,"#FFFFFF",true).layer(this.id);linename=c.text(this._text,q,p+j).align("center").color("#FFFFFF").font("15px sans-serif").layer(this.id),linelen=c.text(Math.floor(this._length)+"m",q,p-m).align("center").color("#FFFFFF").font("15px sans-serif").layer(this.id);c.layer(this.id).draggable();var g=linelen.getRect().height;var o=function(){var v=n.position(),u=l.position(),t=u.x-v.x,s=u.y-v.y,y=(v.x+u.x)/2,w=(v.y+u.y)/2,x=Math.sqrt(Math.pow(t,2)+Math.pow(s,2));h.translateTo(v.x,v.y);f.translateTo(u.x,u.y);r.points([[n._x+n._transformdx,n._y+n._transformdy],[l._x+l._transformdx,l._y+l._transformdy]]);linename.translateTo(y,w+j-g);linelen.translateTo(y,w-m-g).string(Math.floor(b.pixel_to_meter(x))+"m");obj._length=b.pixel_to_meter(x);obj._pt1pos={x:n._x+n._transformdx,y:n._y+n._transformdy};obj._pt2pos={x:l._x+l._transformdx,y:l._y+l._transformdy}};n.draggable(o);n.optns.drag.val=false;l.draggable(o);l.optns.drag.val=false;n.mouseover(function(){c.layer(obj.id).optns.drag.val=false;n.optns.drag.val=true});n.mouseout(function(){c.layer(obj.id).optns.drag.val=true;n.optns.drag.val=false});l.mouseover(function(){c.layer(obj.id).optns.drag.val=false;l.optns.drag.val=true});l.mouseout(function(){c.layer(obj.id).optns.drag.val=true;l.optns.drag.val=false});return this};this.BB_scout=function(g,e,k,j,h){if(h===undefined){h="rgb(255, 0, 0)"}this.id=UUID.genV1().toString();this.type="scout";this._text=g;this._radius=e;this._length=k;this._duration=j;this._color=h;this.draw();var f=b.meter_to_pixel(this._radius);this.move(f,f);this.regist()};this.BB_scout.prototype=new this.BB_base();this.BB_scout.prototype.draw=function(){var j=b.meter_to_pixel(this._radius),h=b.meter_to_pixel(this._length),k=this;var l=c.circle(0,0,j,this._color,false).layer(this.id).opacity(1),e=c.circle(0,0,j,this._color,true).opacity(0.3).layer(this.id),g=c.scout(0,0,j,h,this._color).opacity(0.2).layer(this.id),f=c.scout_mask(0,0,j,h).layer(this.id);c.circle(0,0,3,"#FFFFFF",true).layer(this.id);c.text(this._text,0,-10).align("center").color("#FFFFFF").font("15px sans-serif").layer(this.id);c.layer(this.id).draggable();f.mousedown(function(m){var n=e.position();var p=Math.atan2((m.y-n.y),(m.x-n.x)),o=(c.layer(k.id)._transform21<0)?Math.acos(c.layer(k.id)._transform11):(-1)*Math.acos(c.layer(k.id)._transform11);f.mousemove(function(s){var r=Math.atan2((s.y-n.y),(s.x-n.x));var q=o+(r-p);c.layer(k.id).rotateTo((q*180/Math.PI),0,0)})});f.mouseup(function(m){f.mousemove(function(){})});f.mouseover(function(){c.layer(k.id).optns.drag.val=false});f.mouseout(function(){c.layer(k.id).optns.drag.val=true});f.dblclick(function(){e.translate(h,0,k._duration*1000,undefined,{fn:function(){l.animate({x:e._transformdx,y:e._transformdy})}},function(){k.redraw()});return false});return this};this.BB_sensor=function(g,e,h){if(h===undefined){h="rgb(255, 0, 0)"}this.id=UUID.genV1().toString();this.type="sensor";this._text=g;this._radius=e;this._color=h;this.draw();var f=b.meter_to_pixel(this._radius);this.move(f,f);this.regist()};this.BB_sensor.prototype=new this.BB_base();this.BB_sensor.prototype.draw=function(){var e=b.meter_to_pixel(this._radius);c.circle(0,0,e,this._color,false).opacity(1).layer(this.id);c.circle(0,0,e,this._color,true).opacity(0.5).layer(this.id);c.circle(0,0,3,this._color,true).layer(this.id).color("#FFFFFF");c.text(this._text,0,-10).align("center").layer(this.id).color("#FFFFFF").font("15px sans-serif");c.layer(this.id).draggable();return this};this.BB_radar=function(h,f,e,j){if(j===undefined){j="rgb(255, 0, 0)"}this.id=UUID.genV1().toString();this.type="radar";this._text=h;this._radius=f;this._angle=e;this._color=j;this.draw();var g=b.meter_to_pixel(this._radius);this.move(g,g);this.regist()};this.BB_radar.prototype=new this.BB_base();this.BB_radar.prototype.draw=function(){var f=b.meter_to_pixel(this._radius),g=this;c.radar(0,0,f,this._angle,this._color,false).opacity(1).layer(this.id);var e=c.radar(0,0,f,this._angle,this._color,true).opacity(0.5).layer(this.id);c.circle(0,0,3,this._color,true).layer(this.id).color("#FFFFFF");var h=c.text(this._text,60,0).align("center").layer(this.id).color("#FFFFFF").font("15px sans-serif");e.mousedown(function(k){var o=e.position(),l=b.meter_to_pixel(g._radius),j=Math.sqrt(Math.pow((k.x-o.x),2)+Math.pow((k.y-o.y),2)),n=Math.atan2((k.y-o.y),(k.x-o.x)),m=(c.layer(g.id)._transform21<0)?Math.acos(c.layer(g.id)._transform11):(-1)*Math.acos(c.layer(g.id)._transform11);e.mousemove(function(s){var r=e.position(),q=Math.atan2((s.y-r.y),(s.x-r.x)),p=m+(q-n);c.layer(g.id).rotateTo((p*180/Math.PI),0,0);g.moveTo(s.x-j*Math.cos(q),s.y-j*Math.sin(q))})});e.mouseup(function(j){e.mousemove(function(){})});return this};this.BB_howitzer=function(h,g,e,k,j){if(j===undefined){j="#FFA500"}this.id=UUID.genV1().toString();this.type="hewitzer";this._text=h;this._radius1=g;this._radius2=e;this._radius3=k;this._color=j;this._markerx=0;this._markery=0;this.draw();var f=b.meter_to_pixel(this._radius1);this.move(f,f);this.regist()};this.BB_howitzer.prototype=new this.BB_base();this.BB_howitzer.prototype.draw=function(){var m=b.meter_to_pixel(this._radius1),l=b.meter_to_pixel(this._radius2),k=b.meter_to_pixel(this._radius3)+l,g=this;c.circle(0,0,m,this._color,false).opacity(1).layer(this.id);var h=c.circle(0,0,m,this._color,true).opacity(0.2).layer(this.id),e=c.circle(this._markerx,this._markery,k,this._color,false).opacity(1).layer(this.id),j=c.circle(this._markerx,this._markery,l,this._color,false).opacity(1).layer(this.id),n=c.crosshair(this._markerx,this._markery).layer(this.id),f=c.circle(this._markerx,this._markery,l,this._color,true).opacity(0.3).layer(this.id);c.circle(0,0,3,"#FFFFFF",true).layer(this.id);c.text(this._text,0,-40).align("center").color("#FFFFFF").font("15px sans-serif").layer(this.id);c.layer(this.id).draggable();f.draggable(function(v){var q=true,t=f.position(),o=h.position(),p=c.layer(g.id),z=v.x-o.x,w=v.y-o.y;if(Math.sqrt(Math.pow(z,2)+Math.pow(w,2))>m){q=false}else{q=true}if(q){j.translateTo(t.x,t.y);n.translateTo(t.x,t.y);e.translateTo(t.x,t.y)}else{var r=Math.atan2((v.y-o.y),(v.x-o.x));var u=o.x+m*Math.cos(r);var s=o.y+m*Math.sin(r);f.translateTo(u,s);f.translateTo(u,s);j.translateTo(u,s);n.translateTo(u,s);e.translateTo(u,s)}g._markerx=e._x+e._transformdx;g._markery=e._y+e._transformdy});f.optns.drag.val=false;f.mouseover(function(){c.layer(g.id).optns.drag.val=false;f.optns.drag.val=true});f.mouseout(function(){c.layer(g.id).optns.drag.val=true;f.optns.drag.val=false});f.dblclick(function(){var o=h.position();f.translateTo(o.x,o.y);j.translateTo(o.x,o.y);n.translateTo(o.x,o.y);e.translateTo(o.x,o.y);g._markerx=e._x+e._transformdx;g._markery=e._y+e._transformdy;return false});return this};this.BB_freehand=function(e){if(e===undefined){e="rgb(255, 255, 255)"}this.id=UUID.genV1().toString();this.type="freehand";this._color=e;this._step=0;c.rect(0,0,1,1,"rgba(0, 0, 0, 0)").layer(this.id);this.regist()};this.BB_freehand.prototype.color=function(e){if(e===undefined){return this._color}this._color=e;return this};this.BB_freehand.prototype.toString=this.BB_base.prototype.toString;this.BB_freehand.prototype.regist=this.BB_base.prototype.regist;this.BB_freehand.prototype.up=this.BB_base.prototype.up;this.BB_freehand.prototype.down=this.BB_base.prototype.down;this.BB_freehand.prototype.del=this.BB_base.prototype.del;this.BB_freehand.prototype.start=function(){var h=this,g=c.layer(this.id),f=jc.canvas(b.id);var e=c.rect(0,0,f.width(),f.height(),"rgba(0, 0, 0, 0)").layer("hooker_"+this.id).level("top");e.click(function(){return false});e.dblclick(function(){return false});e.mousemove(function(){return false});e.mousedown(function(k){h._step++;var j=c.line([[k.x,k.y],[k.x,k.y]],h._color).layer(h.id).id(h._step).lineStyle({lineWidth:3});e.mousemove(function(l){j.addPoint(l.x,l.y);return false});return false});e.mouseup(function(){e.mousemove(function(){});return false});return this};this.BB_freehand.prototype.undo=function(){if(this._step!=0){jc("#"+this._step,{canvas:b.id,layer:this.id}).del();this._step--}return this};this.BB_freehand.prototype.end=function(){c.layer("hooker_"+this.id).del();return this}};BB.prototype.touchToMouse=function(a){var g=5;var h=0,f=false,j=false,b=0,e=0,d=0;var c=this;function m(n){var o;switch(n.type){case"touchstart":o=n.touches[0];h=o.identifier;touchx=o.clientX;touchy=o.clientY;break;case"touchmove":for(i=0;i<n.changedTouches.length;i++){if(n.changedTouches[i].identifier==h){o=n.changedTouches[i];break}}break;case"touchend":for(i=0;i<n.changedTouches.length;i++){if(n.changedTouches[i].identifier==h){o=n.changedTouches[i];break}}break}if(o===undefined){return false}return o}function l(n,p){var o=document.createEvent("MouseEvent");o.initMouseEvent(n,true,true,window,((n=="dblclick")?2:1),p.screenX,p.screenY,p.clientX,p.clientY,false,false,false,false,0,null);p.target.dispatchEvent(o)}function k(s){var q=jc.canvas(c.id).cnv.getBoundingClientRect();var o=s.clientX-q.left,r=s.clientY-q.top;for(var p in (c.member)){if((c.object(p)).type=="freehand"){continue}var n=jc.layer(p).isPointIn(o,r);if(n){break}}return n}a.addEventListener("touchstart",function(n){var o=m(n);j=k(o);if(!j){return}n.preventDefault();f=true;if(b&&(Math.abs(e-o.clientX)>g||Math.abs(d-o.clientY)>g)){clearTimeout(b);b=0}e=o.clientX;d=o.clientY;l("mousemove",o);jc.canvas(BB.id).frame();l("mousedown",o);return false},false);a.addEventListener("touchmove",function(s){if(!j){return}var t=m(s);s.preventDefault();var r=s.target.getBoundingClientRect();var q=r.left,o=r.top,p=s.target.offsetWidth||s.target.width,n=s.target.offsetHeight||s.target.height;if(t.clientX>q&&t.clientY>o&&t.clientX<q+p&&t.clientY<o+n){if(!f){l("mouseover",t)}l("mousemove",t);f=true}else{if(f){l("mouseout",t)}f=false}},false);a.addEventListener("touchend",function(n){if(!j){return}n.preventDefault();if(!f){return}var o=m(n);l("mouseup",o);if(Math.abs(e-o.clientX)<g&&Math.abs(d-o.clientY)<g){if(b){l("click",o);l("dblclick",o);clearTimeout(b);b=0}else{l("click",o);b=setTimeout(function(){b=0},500);e=o.clientX;d=o.clientY}}f=false},false)};BB.prototype.meter_to_pixel=function(a){return(a*this.scale)};BB.prototype.pixel_to_meter=function(a){return(a/this.scale)};BB.prototype.setbg=function(c,b,a){var e=new Image;var d=this.jcanvas;var f=this.id;if(a===undefined){a=1}e.src=c;e.onload=function(){var g=document.getElementById(f);g.width=e.width*a;g.height=e.height*a;jc.clear(f);d.image(e,0,0,e.width*a,e.height*a).level(-1).id("bg");jc.start(f,true)};this.scale=b*a;this.imgscale=a;this.member={}};BB.prototype.setbgdiff=function(b){var d=new Image;var c=this.jcanvas;var e=this.id;var a=this.imgscale;if(b){d.src=b;d.onload=function(){c("#bgdiff").del();c.imgdiff(d,0,0,d.width*a,d.height*a).level(0).id("bgdiff");jc.start(e,true)}}else{c("#bgdiff").del()}};BB.prototype.object=function(a){return this.member[a]};BB.prototype.nextlevel=function(d){var a=undefined,b=undefined;for(var c in this.member){if((a===undefined)&&(this.jcanvas.layer(c).level()>d)){a=this.jcanvas.layer(c).level();b=c}else{if((this.jcanvas.layer(c).level()>d)&&(this.jcanvas.layer(c).level()<a)){a=this.jcanvas.layer(c).level();b=c}}}return{id:b,level:a}};BB.prototype.prevlevel=function(d){var a=undefined,b=undefined;for(var c in this.member){if((a===undefined)&&(this.jcanvas.layer(c).level()<d)){a=this.jcanvas.layer(c).level();b=c}else{if((this.jcanvas.layer(c).level()<d)&&(this.jcanvas.layer(c).level()>a)){a=this.jcanvas.layer(c).level();b=c}}}return{id:b,level:a}};BB.prototype.save=function(){return(jc.canvas(this.id).toDataURL("image/png"))};BB.prototype.add_circle=function(c,a,b){return new this.BB_circle(c,a,b)};BB.prototype.add_line=function(b,c,a){return new this.BB_line(b,c,a)};BB.prototype.add_scout=function(c,a,d,e,b){return new this.BB_scout(c,a,d,e,b)};BB.prototype.add_sensor=function(c,a,b){return new this.BB_sensor(c,a,b)};BB.prototype.add_radar=function(c,a,d,b){return new this.BB_radar(c,a,d,b)};BB.prototype.add_howitzer=function(d,e,c,b,a){return new this.BB_howitzer(d,e,c,b,a)};BB.prototype.add_freehand=function(a){return new this.BB_freehand(a)};